<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teatro Nacional - Venta de Boletos</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <header>
        <h1>Teatro Nacional</h1>
        <nav>
            <ul>
                <li><a href="index.html">Inicio</a></li>
                <li><a href="galeria.html">Galería</a></li>
                <li><a href="ACERCA DE.html">Acerca de</a></li>
                <li><a href="CONTACTO.html">Contacto</a></li>
                <li><a href="ventaBoletos.html">Venta de Boletos</a></li>
                <li><a href="Programadores.html">Creadores</a></li>
            </ul>
        </nav>
    </header>

    <main class="contenido-principal">
        <section class="venta-boletos">
            <h1>Venta de Boletos</h1>
            <p>Selecciona la función y completa tus datos para reservar tus boletos.</p>

            <div id="react-compra-root">
                <p>Cargando módulo de compra...</p>
            </div>
            
        </section>
        
        <div id="historial-container"></div>
    </main>

    <footer>Eventos Teatro Nacional De El Salvador<br><br>
        <a href="https://creativecommons.org">Teatro Nacional Pagina Oficial</a> © 2025 by <a href="https://creativecommons.org">Proyecto DAW </a> is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a><img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em;"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em;"><img src="https://mirrors.creativecommons.org/presskit/icons/sa.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em;">
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script> 
    
        <script type="text/babel">
// js/compraReact.js (Puntos 3 y 4)

// Datos de las obras
const EVENTOS_DISPONIBLES = [
    { id: 'figaro', titulo: "Fígaro, Viva la Ópera", fecha: "Sábado 22 de marzo", sala: "Sala de Cámara" },
    { id: 'bella', titulo: "La bella y la bestia", fecha: "Domingo 23 de marzo", sala: "Teatro Principal" },
    { id: 'concierto', titulo: "Concierto de la Orquesta", fecha: "Viernes 21 de marzo", sala: "Teatro Principal" },
];

const getEvento = (id) => EVENTOS_DISPONIBLES.find(e => e.id === id);


const QRCodeDisplay = ({ qrContent, eventoTitulo }) => {
    const qrRef = React.useRef(null);

    React.useEffect(() => {
        if (qrRef.current) {
            qrRef.current.innerHTML = ''; 
            
            new QRCode(qrRef.current, {
                text: qrContent,
                width: 110,
                height: 110,
                colorDark : "#181818",
                colorLight : "#f9f9f9",
                correctLevel : QRCode.CorrectLevel.H
            });
        }
    }, [qrContent]);

    return (
        <div style={{ padding: '15px', marginTop: '15px', background: '#333537', borderRadius: '8px', border: '1px solid #bfa14a33', textAlign: 'center' }}>
            <p style={{ margin: '0 0 10px 0', fontSize: '0.9rem', color: '#dcd6b8' }}>
                **QR adjunto (Simulado):** Escanea para ver detalles de **{eventoTitulo}**
            </p>
            <div ref={qrRef} style={{ margin: '0 auto', width: '110px', height: '110px' }}></div>
        </div>
    );
};

const FormularioCompra = () => {
    // Estados que manejarán los inputs
    const [nombre, setNombre] = React.useState('');
    const [email, setEmail] = React.useState('');
    const [selectedFuncionId, setSelectedFuncionId] = React.useState('');
    const [selectedTipo, setSelectedTipo] = React.useState('');
    const [cantidad, setCantidad] = React.useState(1);
    
    const [isLoading, setIsLoading] = React.useState(false);
    const [confirmation, setConfirmation] = React.useState(null);

    // Lógica para calcular precios (copiada y adaptada de tu JS original)
    const calcularPrecios = () => {
        let precioUnitario = 0;
        switch (selectedTipo.toLowerCase()) {
            case "general": precioUnitario = 5.0; break;
            case "preferencial": precioUnitario = 8.0; break;
            case "vip": precioUnitario = 12.0; break;
            default: precioUnitario = 0;
        }

        const subtotal = +(precioUnitario * cantidad).toFixed(2);
        const impuestos = +(subtotal * 0.13).toFixed(2);
        const total = +(subtotal + impuestos).toFixed(2);
        
        return { precioUnitario, subtotal, impuestos, total };
    };

    const { total } = calcularPrecios();

    // Función de envío (Simulación AJAX - Punto 4)
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // Validación básica (el resto lo hace el input)
        if (!nombre || !email || !selectedFuncionId || !selectedTipo || cantidad < 1 || cantidad > 10) {
            mostrarError("Por favor, completa todos los campos y revisa la cantidad.");
            return;
        }
        
        const nombreRe = /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s-]+$/;
        if (!nombreRe.test(nombre)) {
            mostrarError("El nombre solo puede contener letras, espacios y guiones.");
            return;
        }

        setIsLoading(true);
        const selectedEvent = getEvento(selectedFuncionId);
        const precios = calcularPrecios();
        
        // **Simulación AJAX (Punto 4)** - Simula 2 segundos de latencia de red
        await new Promise(resolve => setTimeout(resolve, 2000)); 

        setIsLoading(false);

        // Crear objeto compra para LocalStorage 
        const compra = {
            nombre: nombre,
            correo: email,
            funcion: selectedEvent.titulo,
            tipo: selectedTipo,
            cantidad: cantidad,
            precioUnitario: precios.precioUnitario,
            subtotal: precios.subtotal,
            impuestos: precios.impuestos,
            total: precios.total,
            fecha: new Date().toLocaleString()
        };

        // Guardar en localStorage
        let compras = JSON.parse(localStorage.getItem("compras")) || [];
        compras.push(compra);
        localStorage.setItem("compras", JSON.stringify(compras));
        
        // Generar la confirmación y mostrar el resumen
        setConfirmation({
            nombre: nombre,
            eventoTitulo: selectedEvent.titulo,
            qrLink: window.location.href, // QR dirige a la página actual
            total: precios.total,
            email: email,
        });
        
        // Notificar a SweetAlert (opcional, ya que mostramos el resumen)
        Swal.fire({
            title: "¡Compra procesada! ✅",
            html: `Se ha simulado el envío de su boleto a <b>${email}</b>. Total pagado: <b>${formatMoneda(precios.total)}</b>.`,
            icon: "success",
            confirmButtonColor: "#bfa14a",
            background: '#232526',
            color: '#f5f5f5'
        });
    };
    
    // --- Renderizado Condicional: Resumen o Formulario ---

    if (confirmation) {
        // Muestra el resumen 
        return (
            <div className="resumen-compra">
                <h2>✅ Compra Exitosa - Correo Enviado</h2>
                <div className="detalle" style={{border: 'none'}}>
                    <p style={{ color: '#d6c98a', lineHeight: '1.5', margin: '10px 0' }}>
                        ¡Felicidades, **{confirmation.nombre}**!
                        <br/>Tu boleto para la función **"{confirmation.eventoTitulo}"** ha sido **enviado a {confirmation.email} (Simulado)**.
                    </p>
                </div>
                
                {/* Texto del correo simplificado solicitado */}
                <blockquote style={{ borderLeft: '3px solid #bfa14a', paddingLeft: '15px', margin: '15px 0', fontSize: '0.95rem', color: '#f5f5f5' }}>
                    *Cuerpo del Correo:* "Gracias por tu compra del boleto para **{confirmation.eventoTitulo}**. Presenta el código QR adjunto para ingresar al Teatro Nacional."
                </blockquote>
                
                <QRCodeDisplay 
                    qrContent={confirmation.qrLink} 
                    eventoTitulo={confirmation.eventoTitulo}
                />
                
                <button 
                    onClick={() => setConfirmation(null)} 
                    style={{ marginTop: '20px', padding: '12px 0' }}
                >
                    Comprar otro boleto
                </button>
            </div>
        );
    }

    // Muestra el formulario de compra 
    return (
        <form onSubmit={handleSubmit} className="formulario-boletos">
            {/* Campo Nombre */}
            <div className="campo">
                <label htmlFor="reactNombre">Nombre del comprador:</label>
                <input 
                    type="text" id="reactNombre" name="nombre" 
                    value={nombre} 
                    onChange={(e) => setNombre(e.target.value)} 
                    placeholder="Tu nombre completo" required 
                    disabled={isLoading}
                />
            </div>

            {/* Campo Email */}
            <div className="campo">
                <label htmlFor="reactCorreo">Correo electrónico:</label>
                <input 
                    type="email" id="reactCorreo" name="correo" 
                    value={email} 
                    onChange={(e) => setEmail(e.target.value)} 
                    placeholder="ejemplo@correo.com" required 
                    disabled={isLoading}
                />
            </div>

            {/* Combobox de Función */}
            <div className="campo">
                <label htmlFor="reactFuncion">Función:</label>
                <select 
                    id="reactFuncion" name="funcion" 
                    value={selectedFuncionId} 
                    onChange={(e) => setSelectedFuncionId(e.target.value)}
                    required
                    disabled={isLoading}
                >
                    <option value="">-- Selecciona una función --</option>
                    {EVENTOS_DISPONIBLES.map(evento => (
                        <option key={evento.id} value={evento.id}>
                            {evento.titulo}
                        </option>
                    ))}
                </select>
            </div>
            
            {/* Tipo de asiento */}
            <div className="campo">
                <label htmlFor="reactTipo">Tipo de asiento:</label>
                <select 
                    id="reactTipo" name="tipo" 
                    value={selectedTipo}
                    onChange={(e) => setSelectedTipo(e.target.value)}
                    required disabled={isLoading}
                >
                    <option value="">-- Selecciona tipo --</option>
                    <option value="General">General ($5.00 + IVA)</option>
                    <option value="Preferencial">Preferencial ($8.00 + IVA)</option>
                    <option value="VIP">VIP ($12.00 + IVA)</option>
                </select>
            </div>

            {/* Cantidad de boletos */}
            <div className="campo">
                <label htmlFor="reactCantidad">Cantidad de boletos:</label>
                <input 
                    type="number" id="reactCantidad" name="cantidad" 
                    min="1" max="10" value={cantidad} 
                    onChange={(e) => setCantidad(parseInt(e.target.value, 10))}
                    required disabled={isLoading}
                />
            </div>
            
            {/* Total (Se muestra en tiempo real) */}
            {selectedTipo && cantidad >= 1 && (
                <div style={{ padding: '10px 0', borderTop: '1px solid #333', marginTop: '15px' }}>
                    <p style={{ color: '#bfa14a', fontWeight: 'bold', textAlign: 'center', fontSize: '1.2rem' }}>
                        TOTAL ESTIMADO: {formatMoneda(total)}
                    </p>
                </div>
            )}
            
            <div className="acciones">
                <button type="submit" disabled={isLoading} style={{ opacity: isLoading ? 0.7 : 1 }}>
                    {isLoading ? 'Simulando Compra y Envío...' : 'Comprar Boleto y Enviar Correo (Simulado)'}
                </button>
            </div>
        </form>
    );
};


// 4. Montar el componente React
const container = document.getElementById('react-compra-root');
const root = ReactDOM.createRoot(container);
root.render(<FormularioCompra />)
    </script> 
    
    <script>
    // Este script se encarga de leer el historial de compras y mostrarlo.
    
    // Función de formato 
    window.formatMoneda = (valor) => valor.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

    window.renderHistorial = () => {
        const compras = JSON.parse(localStorage.getItem("compras")) || [];
        const container = document.getElementById('historial-container');
        
        if (!container) return;
        container.innerHTML = ''; // Limpia el contenido anterior

        if (compras.length === 0) {
            return;
        }

        const historialTitulo = document.createElement('h2');
        historialTitulo.classList.add('titulo');
        historialTitulo.textContent = 'Historial de Compras Anteriores';
        historialTitulo.style.marginTop = '40px'; 
        historialTitulo.style.textAlign = 'center'; 

        const historialContenedor = document.createElement('div');
        historialContenedor.id = 'historialCompras'; 
        
        compras.reverse().forEach((compra, index) => {
            const card = document.createElement('div');
            card.classList.add('resumen-card');
            card.style.maxWidth = '360px'; 
            
            card.innerHTML = `
                <h2>Compra Historial #${compras.length - index}</h2>
                <div class="detalle">
                    <span class="etiqueta">Comprador:</span>
                    <span class="valor">${compra.nombre}</span>
                </div>
                <div class="detalle">
                    <span class="etiqueta">Función:</span>
                    <span class="valor">${compra.funcion}</span>
                </div>
                <div class="detalle total">
                    <span class="etiqueta">TOTAL:</span>
                    <span class="valor">${window.formatMoneda(compra.total)}</span>
                </div>
                <p class="nota">${compra.fecha}</p>
            `;
            historialContenedor.appendChild(card);
        });

        container.appendChild(historialTitulo);
        container.appendChild(historialContenedor);
    };

    // Llamar a la función al cargar la página
    document.addEventListener('DOMContentLoaded', window.renderHistorial);
    </script>
    
</body>
</html>